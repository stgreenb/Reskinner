{"version":3,"file":"ds-reskinner.mjs","sources":["src/reskinner-app.js","src/module.js"],"sourcesContent":["/**\n * ReskinApp - Main application for reskinning monsters\n */\n\n/**\n * Application to be mixed in with Foundry's Handlebars functionality\n */\nconst HandlebarsApplication = foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2);\n\n/**\n * The Reskin application window\n */\nexport class ReskinApp extends HandlebarsApplication {\n  /**\n   * Create the ReskinApp\n   * @param {Actor} actor - The actor to reskin\n   * @param {Object} options - Additional options\n   */\n  constructor(actor, options = {}) {\n    super(options);\n    \n    this.actor = actor;\n  }\n\n  /**\n   * Default configuration for the application\n   * @returns {Object} Application options\n   * @override\n   */\n  /**\n   * Get the content template for the application\n   * @returns {string} Template path\n   * @override\n   */\n  get template() {\n    return 'modules/ds-reskinner/templates/reskin-form.hbs';\n  }\n\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      window: {\n        title: game.i18n.localize('DSRESKINNER.ReskinMonster'),\n        contentClasses: ['reskinner-app'],\n        minimizable: true,\n        resizable: false\n      },\n      position: {\n        width: 400,\n        height: 300\n      }\n    });\n  }\n\n  /**\n   * Get the data object for the template\n   * @returns {Object} Template data\n   * @override\n   */\n  _prepareContext(options) {\n    return {\n      actor: this.actor,\n      actorName: this.actor.name,\n      actorId: this.actor.id\n    };\n  }\n\n  /**\n   * Activate event listeners\n   * @param {HTMLElement} html - The rendered HTML\n   * @override\n   */\n  _activateListeners(html) {\n    super._activateListeners(html);\n\n    // Handle form submission\n    // In V2 HandlebarsApplication, we need to bind the form submit handler manually\n    const form = html.querySelector('form.reskinner-form');\n    if (form) {\n      form.addEventListener('submit', this._onFormSubmit.bind(this));\n    }\n    \n    // Add support for the cancel button click\n    const cancelButtons = html.querySelectorAll('.cancel-btn');\n    cancelButtons.forEach(button => {\n      button.addEventListener('click', () => {\n        this.close();\n      });\n    });\n  }\n\n  /**\n   * Handle form submission\n   * @param {Event} event - The submit event\n   * @private\n   */\n  async _onFormSubmit(event) {\n    event.preventDefault();\n    \n    // Get the form data directly from the event target to access the submitted data\n    const form = event.target;\n    const formData = new FormData(form);\n    const newName = formData.get('actorName');\n    \n    if (!newName || newName.trim() === '') {\n      ui.notifications.error(game.i18n.localize('DSRESKINNER.NameEmptyError'));\n      return;\n    }\n\n    try {\n      // Create a new actor based on the current actor's data\n      const sourceData = this.actor.toObject();\n      \n      // Update the name and generate a new ID for the new actor\n      const newActorData = foundry.utils.mergeObject(sourceData, {\n        name: newName.trim(),\n        _id: null, // This ensures a new ID will be generated\n        folder: null, // Don't assign to any specific folder by default\n        ownership: { // Ensure proper ownership defaults\n          default: CONST.DOCUMENT_OWNERSHIP_LEVELS.NONE\n        }\n      });\n\n      // Create the cloned actor in the actors directory\n      await Actor.create(newActorData);\n      \n      ui.notifications.info(game.i18n.format('DSRESKINNER.CreateSuccess', { name: newName }));\n      this.close();\n    } catch (error) {\n      console.error('Draw Steel Reskinner | Error creating reskin:', error);\n      ui.notifications.error(game.i18n.localize('DSRESKINNER.CreateError'));\n    }\n  }\n}\n","/**\n * Draw Steel Reskinner Module\n * A Foundry VTT module for reskinning Draw Steel monsters\n * Version: 0.1.25 - Enhanced actor detection and V2 Application framework compatibility\n */\n\n// Centralized version reference to ensure consistency across the module\nconst MODULE_VERSION = '0.1.25';\n\nimport { ReskinApp } from './reskinner-app.js';\n\n/**\n * Check if an actor is a monster NPC that can be reskinned\n * @param {Actor} actor - The actor to check\n * @returns {boolean} True if the actor is a reskinnable monster\n */\nfunction isReskinnableMonster(actor) {\n  // Check if it's an NPC (monster) in the Draw Steel system\n  if (!actor || actor.type !== 'npc') return false;\n  \n  // Check if it's in the Draw Steel system\n  const isDrawSteel = game.system.id === 'draw-steel';\n  if (!isDrawSteel) return false;\n  \n  return true;\n}\n\n/**\n * Add Reskin button to actor sheet headers\n */\nHooks.on('getActorSheetHeaderButtons', (sheet, buttons) => {\n  console.log('getActorSheetHeaderButtons hook triggered');\n  console.log('Sheet actor:', sheet.actor);\n  console.log('Is reskinnable?', sheet.actor ? isReskinnableMonster(sheet.actor) : 'No actor found');\n  \n  if (!isReskinnableMonster(sheet.actor)) return;\n  \n  console.log('Adding Reskin button to actor sheet header');\n  buttons.unshift({\n    class: 'reskin-actor',\n    icon: 'fas fa-palette',\n    label: game.i18n.localize('DSRESKINNER.Reskin'),\n    onclick: () => {\n      const reskinApp = new ReskinApp(sheet.actor);\n      reskinApp.render(true);\n    }\n  });\n});\n\n/**\n * Add Reskin option to actor context menu (Foundry VTT v13)\n */\nHooks.on('getActorContextOptions', (html, menuItems) => {\n  console.log('getActorContextOptions called with html element and', menuItems.length, 'existing items');\n  \n  // Add the context menu option for reskinning\n  menuItems.push({\n    name: game.i18n.localize('DSRESKINNER.ReskinMonster'),\n    icon: '<i class=\"fas fa-palette\"></i>',\n    condition: (li) => {\n      console.log('Condition function called with li element:', li);\n      // Get actor ID from the list item's dataset (Foundry V13 way, replacing jQuery .data() method)\n      const actorId = li.dataset.documentId || li.dataset.entryId;\n      if (!actorId) {\n        console.log('No actor ID found in element dataset');\n        return false;\n      }\n      \n      const actor = game.actors.get(actorId);\n      console.log('Found actor in condition:', actor ? {name: actor.name, type: actor.type} : 'none');\n      \n      const result = actor ? isReskinnableMonster(actor) : false;\n      console.log('Condition result:', result);\n      return result;\n    },\n    callback: (li) => {\n      console.log('Callback function called with li element:', li);\n      // Get actor ID from the list item's dataset (Foundry V13 way, replacing jQuery .data() method)\n      const actorId = li.dataset.documentId || li.dataset.entryId;\n      if (!actorId) {\n        console.warn('No actor ID found in element dataset');\n        return;\n      }\n      \n      const actor = game.actors.get(actorId);\n      if (!actor) {\n        console.warn('Could not find actor with ID:', actorId);\n        return;\n      }\n      \n      console.log('Opening reskin app for actor:', actor.name);\n      new ReskinApp(actor).render(true);\n    }\n  });\n});\n\n/**\n * Main module class for initialization and hooks\n */\nclass DrawSteelReskinner {\n  static init() {\n    console.log(`Draw Steel Reskinner | Initializing module version ${MODULE_VERSION} - Enhanced actor detection including DOM traversal when app.context is undefined`);\n  }\n\n  static ready() {\n    console.log(`Draw Steel Reskinner | Ready - all hooks registered version ${MODULE_VERSION}`);\n  }\n}\n\n// Register the module hooks\nHooks.on('init', () => {\n  DrawSteelReskinner.init();\n});\n\nHooks.on('ready', () => {\n  DrawSteelReskinner.ready();\n});\n\n// Log module initialization\nconsole.log(`Draw Steel Reskinner | Module loaded version ${MODULE_VERSION}`);\n"],"names":[],"mappings":"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"}